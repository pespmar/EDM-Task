---
title: "Interface"
author: "Pablo, Juan, Alejandro"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(shiny)
library(shinydashboard)
library(leaflet)
library(DT)
library(plotly)
library(dplyr)
```



```{r}
load('Data.RData')
```



# Pre-Rendered Graphs

Can be seen with more detail in our GitHub - ExploratoryAnalysis


```{r}
load('PreRenderedGraphs.RData')
```



## Options from selection parts
```{r}
opciones = c("AvenidaFrancia", "Centre", "MoliDelSol",
             "PistaDeSilla", "UPV", "Olivereta"
             , "Puerto", "AllStations")

variables = c("PM2.5" , "SO2" , "NO" , "NO2" , "NOx" , "O3" , "CO")


missingdatamethods = c('None' , 'Mean' , 'Interpolation')

```


## Slice of All Stations

```{r}

set.seed(123)

AllStations = COMPLETE
COMPLETESLICE = na.omit(AllStations) %>% sample_n(size = 1000)
```


# UI

```{r}
ui <- dashboardPage(
  dashboardHeader(title = "Air Contamination"),
  dashboardSidebar(
    sidebarMenu(
      menuItem("Data Exploratory Analysis", tabName = "exploratory", icon = icon("chart-bar")),
      menuItem("Data Science Model", tabName = "model", icon = icon("robot")),
      menuItem("Pollution Map", tabName = "map", icon = icon("map"))
    )
  ),
  
  
  dashboardBody(
    tabItems(

      tabItem(tabName = "exploratory",
              h1("Data Exploratory Analysis"),
              hr(),
              p('In this section you can see different distributions of our data
              and play with them'),
              h3('Scatter Plots'),
              selectInput("variable1", "Select the first variable:",
              choices = variables),
              selectInput("variable2", "Select the second variable:",
              choices = variables),
              plotlyOutput("scatterPlot"),
              hr(),
              hr(),
              h1('Analysis per Station'),
              selectInput("select", "Select one Station:", choices = opciones),
              h3('Hour analysis'),
              uiOutput("plot"),
              h3('Dealing with missing Data'),
              p('We have some missing data from every station. To deal with it, we
                prerent some different approaches'),
              tags$ul(
                tags$li("Filling data with the total mean from the station"),
                tags$li("Filling data Interpolating from last and next day"),
              ),
              selectInput("missingdata", "Select the missing data method:",
              choices = missingdatamethods),
              plotlyOutput("temporalPlotNA"),
              
      ),
      
      tabItem(tabName = "model",
              h1("Data Science Model"),
              verbatimTextOutput("model_summary")
      ),
      
      tabItem(tabName = "map",
              h1("Pollution Map"),
              leafletOutput("mapa")
      )
    )
  )
)

```



# Server


```{r}
server <- function(input, output, session) {

  
  data <- reactive({
    req(input$file)
    read.csv(input$file$datapath)
  })
  
  output$table <- renderDT({
    datatable(data())
  })
  
  output$plot <- renderUI({
    req(input$select)
    plotlyOutput("selected_plot")
  })
  
  
  output$selected_plot <- renderPlotly({
    req(input$select)
    graficosPMporHora[[input$select]]
  })
  
  

  
  
  output$scatterPlot <- renderPlotly({
    req(input$variable1)
    req(input$variable2)
  
    a = COMPLETESLICE[,input$variable1]
    b = COMPLETESLICE[,input$variable2]
    
    plot_ly(
      data = COMPLETESLICE,
      x = a,
      y = b,
      type = 'scatter',
      mode = 'markers',
      text = ~paste('Date:', FECHA),
      hoverinfo = 'text')%>%
      layout(title = 'Scatter Plot with 1000 points',
         xaxis = list(title = input$variable1),
         yaxis = list(title = input$variable2))
    
    })
    
  
  
  
  
  output$temporalPlotNA <- renderPlotly({


req(input$missingdata) 
req(input$select)    
    
plot_selected <- switch(input$missingdata,
                        'None' = graficosPMporDia[[input$select]],
                        'Interpolation' =graficosPMporDiaInterpolacion[[input$select]],
                        'Mean' = graficosPMporDiaMedia[[input$select]])

plot_selected

  })
    

  
  output$model_summary <- renderPrint({
    req(input$file_modelo, input$variable, input$run_model)
    data_modelo <- read.csv(input$file_modelo$datapath)
    modelo <- lm(as.formula(paste(input$variable, "~ .")), data = data_modelo)
    summary(modelo)
  })

  
  
  output$mapa <- renderLeaflet({
    leaflet() %>%
      addTiles() %>%
      setView(lng = -0.37739, lat = 39.46975, zoom = 13) %>%
      addCircleMarkers(
        lng = c(-0.3426899,
                -0.37648469,
                -0.40855865,
                -0.37665323,
                -0.3374074,
                -0.40603766,
                -0.32321741,
                -0.32894501),
        lat = c(39.45750439,
                39.47071883,
                39.48113875,
                39.45806013,
                39.47962193,
                39.46923859,
                39.45926486,
                39.45051894),
        label = c(
          "AvenidaFrancia",
          "Centre",
          "MolidelSol",
          "PistadeSilla",
          "UPV",
          "Olivereta",
          "Puerto",
          "LlicAnticTuria"
        ),
        color = "red",
      )
  })
  
  
  
  
  
}


```


# Run


```{r}
shinyApp(ui = ui, server = server)
```


